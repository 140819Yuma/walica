<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Split</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #e0e0e0;
            --accent: #4caf50;
            --danger: #ff5252;
            --input-bg: #404040;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        h1, h2 { margin-top: 0; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Input Areas */
        .card {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border: 1px solid #555;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-danger { background-color: var(--danger); color: white; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 10px;}
        
        /* Lists */
        ul { list-style: none; padding: 0; }
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        li:last-child { border-bottom: none; }

        /* Result Area */
        #result-area {
            background: #2e3b2f;
            border: 1px solid var(--accent);
        }
        .transfer-arrow { color: var(--accent); font-weight: bold; margin: 0 5px; }
        .money { font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’¸ Clean Split</h1>

    <div class="card">
        <h2>1. ãƒ¡ãƒ³ãƒãƒ¼</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newMemberName" placeholder="åå‰ (ä¾‹: Aã•ã‚“)">
            <button onclick="addMember()" class="btn-primary" style="width: 30%;">è¿½åŠ </button>
        </div>
        <ul id="memberList"></ul>
    </div>

    <div class="card" id="expenseCard" style="display:none;">
        <h2>2. æ”¯æ‰•ã„è¨˜éŒ²</h2>
        <input type="text" id="expenseTitle" placeholder="ç”¨é€” (ä¾‹: å±…é…’å±‹)">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select id="payerSelect"></select>
            <input type="number" id="expenseAmount" placeholder="é‡‘é¡ (å††)">
        </div>
        <button onclick="addExpense()" class="btn-primary">æ”¯æ‰•ã„ã‚’è¿½åŠ </button>
        <ul id="expenseList"></ul>
    </div>

    <div class="card" id="resultCard" style="display:none;">
        <h2>ğŸ“Š ç²¾ç®—çµæœ</h2>
        <p style="text-align: center; font-size: 0.9em; opacity: 0.8;">åˆè¨ˆ: <span id="totalAmount">0</span>å†† (1äººã‚ãŸã‚Š: <span id="perPerson">0</span>å††)</p>
        <div id="resultList"></div>
    </div>
</div>

<script>
    let members = [];
    let expenses = [];

    function addMember() {
        const nameInput = document.getElementById('newMemberName');
        const name = nameInput.value.trim();
        if (!name) return;
        if (members.includes(name)) { alert('ãã®åå‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'); return; }

        members.push(name);
        nameInput.value = '';
        renderMembers();
        updatePayerSelect();
        
        // 2äººä»¥ä¸Šã«ãªã£ãŸã‚‰æ”¯æ‰•ã„å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        if (members.length >= 2) {
            document.getElementById('expenseCard').style.display = 'block';
        }
        calculate();
    }

    function removeMember(index) {
        members.splice(index, 1);
        renderMembers();
        updatePayerSelect();
        calculate();
    }

    function renderMembers() {
        const list = document.getElementById('memberList');
        list.innerHTML = members.map((m, i) => `
            <li>${m} <button onclick="removeMember(${i})" class="btn-danger">å‰Šé™¤</button></li>
        `).join('');
    }

    function updatePayerSelect() {
        const select = document.getElementById('payerSelect');
        select.innerHTML = members.map(m => `<option value="${m}">${m}ãŒæ‰•ã£ãŸ</option>`).join('');
    }

    function addExpense() {
        const title = document.getElementById('expenseTitle').value || 'æ”¯æ‰•ã„';
        const payer = document.getElementById('payerSelect').value;
        const amount = parseInt(document.getElementById('expenseAmount').value);

        if (!payer || isNaN(amount) || amount <= 0) return;

        expenses.push({ title, payer, amount });
        
        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
        document.getElementById('expenseTitle').value = '';
        document.getElementById('expenseAmount').value = '';
        
        renderExpenses();
        calculate();
    }

    function removeExpense(index) {
        expenses.splice(index, 1);
        renderExpenses();
        calculate();
    }

    function renderExpenses() {
        const list = document.getElementById('expenseList');
        list.innerHTML = expenses.map((e, i) => `
            <li>
                <span>${e.title}: <b>${e.payer}</b> (${e.amount.toLocaleString()}å††)</span>
                <button onclick="removeExpense(${i})" class="btn-danger">Ã—</button>
            </li>
        `).join('');
        
        if (expenses.length > 0) {
            document.getElementById('resultCard').style.display = 'block';
        } else {
            document.getElementById('resultCard').style.display = 'none';
        }
    }

    function calculate() {
        if (members.length === 0 || expenses.length === 0) return;

        let total = 0;
        let balance = {};
        members.forEach(m => balance[m] = 0);

        // æ”¯æ‰•ã„åˆè¨ˆã¨ã€å„å€‹äººã®æ‰•ã„éããƒ»æ‰•ã„ä¸è¶³ã‚’è¨ˆç®—
        expenses.forEach(e => {
            total += e.amount;
            if (balance[e.payer] !== undefined) {
                balance[e.payer] += e.amount;
            }
        });

        const perPerson = Math.floor(total / members.length); // ç«¯æ•°ã¯åˆ‡ã‚Šæ¨ã¦ã¦èª¿æ•´
        document.getElementById('totalAmount').textContent = total.toLocaleString();
        document.getElementById('perPerson').textContent = perPerson.toLocaleString();

        // å·®é¡ã‚’è¨ˆç®— (ãƒ—ãƒ©ã‚¹ãªã‚‰å—ã‘å–ã‚‹å´ã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰æ‰•ã†å´)
        let debtors = [];
        let creditors = [];

        for (let m of members) {
            let diff = balance[m] - perPerson;
            if (diff < -1) debtors.push({ name: m, amount: diff }); // 1å††ç¨‹åº¦ã®èª¤å·®ã¯è¨±å®¹
            if (diff > 1) creditors.push({ name: m, amount: diff });
        }

        // ç²¾ç®—ãƒ­ã‚¸ãƒƒã‚¯ (æœ€å°å›æ•°ã§ã®ç§»å‹•ã‚’ç›®æŒ‡ã™ç°¡æ˜“ç‰ˆ)
        let transactions = [];
        debtors.sort((a, b) => a.amount - b.amount); // å€Ÿé‡‘ãŒå¤šã„é †
        creditors.sort((a, b) => b.amount - a.amount); // å‚µæ¨©ãŒå¤šã„é †

        let i = 0; // debtor index
        let j = 0; // creditor index

        while (i < debtors.length && j < creditors.length) {
            let debtor = debtors[i];
            let creditor = creditors[j];
            
            // ç§»å‹•ã•ã›ã‚‹é‡‘é¡ï¼ˆå€Ÿé‡‘ã®çµ¶å¯¾å€¤ ã¨ å‚µæ¨© ã®å°ã•ã„æ–¹ï¼‰
            let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
            
            transactions.push({ from: debtor.name, to: creditor.name, amount: amount });

            debtor.amount += amount;
            creditor.amount -= amount;

            if (Math.abs(debtor.amount) < 1) i++;
            if (creditor.amount < 1) j++;
        }

        // çµæœè¡¨ç¤º
        const resultList = document.getElementById('resultList');
        if (transactions.length === 0) {
            resultList.innerHTML = '<p style="text-align:center;">ç²¾ç®—ä¸è¦ã§ã™ï¼</p>';
        } else {
            resultList.innerHTML = transactions.map(t => `
                <div style="background:#404040; padding:10px; margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>${t.from}</span>
                    <span class="transfer-arrow">â†’ ${t.amount.toLocaleString()}å†† â†’</span>
                    <span>${t.to}</span>
                </div>
            `).join('');
        }
    }
</script>

</body>
</html>
